name: "CodeQL for Jupyter Notebooks"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 0 * * 0" # Weekly scan

jobs:
  codeql-analysis:
    name: CodeQL Analysis for IPYNB
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        language: ["python"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality, security-extended

      - name: Extract and Convert Jupyter Notebooks
        run: |
          # Install required tools
          pip install jupyter nbconvert pandas numpy

          # Convert all .ipynb files to .py for CodeQL analysis
          echo "Converting Jupyter notebooks to Python scripts..."
          find . -name "*.ipynb" -type f | while read notebook; do
            echo "Converting $notebook"
            python -m nbconvert "$notebook" --to python --stdout > "${notebook%.ipynb}_converted.py" 2>/dev/null || echo "Warning: Could not convert $notebook"
          done

          # Also create a consolidated Python file with all notebook code
          python scripts/convert_notebooks.py

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:python"
